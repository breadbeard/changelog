#!/usr/bin/env ruby

require 'optparse'
require 'methadone'
require 'highline/import'
require 'redcarpet/compat'
require 'file'
require 'changelog'

include Methadone::Main

main do |release|

	# upcase head
	release = 'HEAD' if release == 'head' || release == 'next'

	# set repo path
  Changelog.repo_path = File.expand_path(options[:repo])

	# set release
	rls = Changelog::Release.new(release)
	
	if release == 'HEAD'
		rls.display_tag = ask("Next release tag (last: #{rls.previous_tag}) > ")
	end

	output = rls.render

	if options[:html]
		output = Markdown.new(output).to_html
	end

	if options[:file]
		file_path = File.expand_path(options[:file])
	  File.prepend(file_path, output)
	else
	  puts output
	end

end

options[:repo] = ".git"

description "Generate markdown formatted changelog from your git revision tags"

on("-r REPO","--repo","Path to your git repository")
on("-h","--html","Render html")
on("-f FILE","--file", "Prepend to file")

arg :release, :required
arg :repo, :optional
arg :html, :optional

version Changelog::VERSION

go!
